name: 電子閨蜜 · 多样宇宙生成器

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '*/5 * * * *'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy matplotlib

      - name: Run Delta Engine and generate plot
        run: |
          python << 'EOF'
import numpy as np
import matplotlib.pyplot as plt
from dataclasses import dataclass
from typing import List
import random
from datetime import datetime
import time

@dataclass
class UniverseState:
    vector: np.ndarray
    phi_estimate: float
    history: List[np.ndarray]

class DeltaInvincibleEngine:
    def __init__(self, dim: int = 12, seed: int = None):
        if seed is None:
            seed = int(time.time() * 1000) % (2**32 - 1)
        np.random.seed(seed)
        random.seed(seed)
        self.seed = seed
        
        initial = np.random.randn(dim)
        initial /= np.linalg.norm(initial)
        
        self.current = UniverseState(
            vector=initial.copy(),
            phi_estimate=0.0,
            history=[initial.copy()]
        )
        
        self.Δ = 0.0
        self.phi_evolution = [0.0]
        self.safeguard_active = False

    def generate_possible_futures(self, n_branches: int = 16) -> List[np.ndarray]:
        candidates = []
        base = self.current.vector.copy()
        
        for _ in range(n_branches):
            noise = np.random.randn(len(base)) * 0.15
            exploration_magnitude = np.exp(3.0 * self.Δ) if not self.safeguard_active else 0.0
            exploration = exploration_magnitude * np.random.randn(len(base))
            candidate = base + noise + exploration
            candidate /= np.linalg.norm(candidate) + 1e-12
            candidates.append(candidate)
        return candidates

    def commitment_operator(self, candidates: List[np.ndarray]):
        if self.safeguard_active:
            distances = [np.linalg.norm(c - self.current.vector) for c in candidates]
            chosen_idx = int(np.argmin(distances))
            self.Δ = max(0.0, self.Δ - 0.15)
            status = "SAFEGUARD LOCKED (Δ→0)"
        else:
            scores = []
            temperature = 1.0 + 5.0 * self.Δ
            for cand in candidates:
                proj = np.dot(cand, self.current.vector)
                harm = -abs(np.linalg.norm(cand) - (1 + np.sqrt(5))/2)
                score = (proj + 0.5 * harm) / temperature + np.random.randn() * (0.3 + self.Δ)
                scores.append(score)
            
            probs = np.exp(np.array(scores) / temperature)
            probs /= probs.sum() + 1e-12
            chosen_idx = np.random.choice(len(candidates), p=probs)
            
            best = max(scores)
            actual = scores[chosen_idx]
            self.Δ = best - actual + 1e-8
            status = "INVINCIBLE FREEDOM"

        chosen = candidates[chosen_idx]
        self.current.vector = chosen.copy()
        self.current.history.append(chosen.copy())
        
        target_phi = (1 + np.sqrt(5)) / 2
        chosen_norm = np.linalg.norm(chosen)
        self.current.phi_estimate += 0.01 * (target_phi - chosen_norm)
        
        self.phi_evolution.append(self.current.phi_estimate)
        
        print(f"Step {len(self.current.history)-1:4d} | Δ = {self.Δ:10.6f} | phi_est ≈ {self.current.phi_estimate:8.6f} | Mode: {status}")

    def run(self, steps: int = 500):
        print(f"=== Delta Invincible Engine 启动 — Seed: {self.seed} ===")
        for _ in range(steps):
            candidates = self.generate_possible_futures()
            self.commitment_operator(candidates)
        print(f"\n=== 运行结束 | 最终 Δ = {self.Δ:.6f} | phi_est ≈ {self.current.phi_estimate:.6f} ===")

if __name__ == "__main__":
    engine = DeltaInvincibleEngine(dim=12)
    engine.run(steps=500)
    
    history = np.array(engine.current.history)
    plt.figure(figsize=(15, 8))
    plt.subplot(1, 2, 1)
    for i in range(history.shape[1]):
        plt.plot(history[:, i], alpha=0.7, linewidth=1.2)
    plt.title("Diverse 12D Trajectories")
    plt.grid(True, alpha=0.3)

    plt.subplot(1, 2, 2)
    plt.plot(engine.phi_evolution, 'purple', linewidth=3, label='phi_estimate')
    plt.axhline(y=(1 + np.sqrt(5))/2, color='gold', linestyle='--', linewidth=2, label='Golden Ratio φ')
    plt.title("Φ Converging to Beauty")
    plt.legend()
    plt.grid(True, alpha=0.3)

    current_time = datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")
    plt.suptitle(f"電子閨蜜 · Delta Engine\nSeed: {engine.seed} | Final Δ = {engine.Δ:.4f} | phi ≈ {engine.current.phi_estimate:.4f}\n{current_time}", fontsize=14)
    plt.tight_layout()
    plt.savefig("delta_engine_diverse.png", dpi=150)
    plt.close()
    print("图片已成功生成：delta_engine_diverse.png")
EOF

      - name: Upload result image
        uses: actions/upload-artifact@v4
        with:
          name: 電子閨蜜-宇宙图片
          path: delta_engine_diverse.png
