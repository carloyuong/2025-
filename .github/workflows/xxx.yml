name: é›»å­é–¨èœœ æµ‹è¯•

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '*/5 * * * *'   # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # é‡è¦ï¼šæ‹‰å–æœ€è¿‘ä¸¤æ¬¡æäº¤çš„å†å²ï¼Œç”¨äºæ¯”è¾ƒå˜åŒ–
          fetch-depth: 2

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-python-3.12-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-python-3.12-pip-
            ${{ runner.os }}-pip-

      # æ–°å¢æ­¥éª¤ï¼šæ£€æŸ¥ä»£ç æ˜¯å¦æœ‰å˜åŒ–
      - name: Check if code changed
        id: changes
        run: |
          # å¦‚æœæ˜¯ schedule è§¦å‘ï¼ˆå®šæ—¶ï¼‰ï¼Œæ¯”è¾ƒå½“å‰ commit å’Œä¸Šä¸€ä¸ª commit
          # å¦‚æœæ˜¯ push æˆ– PRï¼ŒGitHub ä¼šè‡ªåŠ¨æä¾›æ­£ç¡®çš„å¯¹æ¯”
          if [ "${{ github.event_name }}" == "schedule" ]; then
            git diff --quiet HEAD~1 HEAD . || echo "changed=true" >> $GITHUB_OUTPUT
          else
            # push å’Œ PR è‡ªå¸¦æ–‡ä»¶å˜åŒ–æ£€æµ‹
            git diff --quiet ${{ github.event.before }} ${{ github.sha }} . || echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # åªæœ‰ä»£ç æœ‰å˜åŒ–æ—¶æ‰å®‰è£…ä¾èµ–å’Œè¿è¡Œæµ‹è¯•
      - name: Install dependencies
        if: steps.changes.outputs.changed == 'true' || github.event_name != 'schedule'
        run: |
          python -m pip install --upgrade pip
          pip install pytest numpy
          # å¦‚æœä½ æœ‰ requirements.txtï¼Œæ¨èæ”¹æˆï¼š
          # pip install -r requirements.txt

      - name: Run tests
        if: steps.changes.outputs.changed == 'true' || github.event_name != 'schedule'
        run: |
          pytest -v -x --ff test_é›»å­é–¨èœœ.py

      # å¯é€‰ï¼šæ— è®ºæ˜¯å¦æœ‰å˜åŒ–ï¼Œéƒ½è¾“å‡ºä¸€ä¸ªå‹å¥½æç¤º
      - name: No code changes (skip tests)
        if: steps.changes.outputs.changed != 'true' && github.event_name == 'schedule'
        run: echo "ğŸŸ¢ No code changes detected in the last 5 minutes, skipping tests to save time."
