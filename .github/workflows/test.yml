name: 電子閨蜜 测试

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '*/5 * * * *'   # 每5分钟自动运行一次

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-python-3.12-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-python-3.12-pip-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy matplotlib

      # 核心步骤：运行你的 Delta Invincible Engine 并生成图片
      - name: Run Delta Engine and generate plot
        run: |
          python - <<'EOF'
          import numpy as np
          import matplotlib.pyplot as plt
          from dataclasses import dataclass
          from typing import List
          import random
          from datetime import datetime

          @dataclass
          class UniverseState:
              vector: np.ndarray
              phi_estimate: float
              history: List[np.ndarray]

          class DeltaInvincibleEngine:
              def __init__(self, dim: int = 12, seed: int = 2026):
                  np.random.seed(seed)
                  random.seed(seed)
                  
                  initial = np.random.randn(dim)
                  initial /= np.linalg.norm(initial)
                  
                  self.current = UniverseState(
                      vector=initial.copy(),
                      phi_estimate=0.0,
                      history=[initial.copy()]
                  )
                  
                  self.Δ = 0.0
                  self.phi_evolution = [0.0]
                  self.safeguard_active = False
                  self._hidden_lock = [0.3141592653, 0.2718281828, 0.1618033988]

              def generate_possible_futures(self, n_branches: int = 16) -> List[np.ndarray]:
                  candidates = []
                  base = self.current.vector.copy()
                  
                  for _ in range(n_branches):
                      noise = np.random.randn(len(base)) * 0.15
                      
                      if not self.safeguard_active:
                          exploration_magnitude = np.exp(3.0 * self.Δ)
                      else:
                          exploration_magnitude = 0.0
                      
                      exploration = exploration_magnitude * np.random.randn(len(base))
                      
                      candidate = base + noise + exploration
                      candidate /= np.linalg.norm(candidate) + 1e-12
                      candidates.append(candidate)
                  
                  return candidates

              def commitment_operator(self, candidates: List[np.ndarray]):
                  if self.safeguard_active:
                      distances = [np.linalg.norm(c - self.current.vector) for c in candidates]
                      chosen_idx = int(np.argmin(distances))
                      self.Δ = max(0.0, self.Δ - 0.15)
                      status = "SAFEGUARD LOCKED (Δ→0)"
                  else:
                      scores = []
                      temperature = 1.0 + 5.0 * self.Δ
                      for cand in candidates:
                          proj = np.dot(cand, self.current.vector)
                          harm = -abs(np.linalg.norm(cand) - (1 + np.sqrt(5))/2)
                          score = (proj + 0.5 * harm) / temperature + np.random.randn() * (0.3 + self.Δ)
                          scores.append(score)
                      
                      probs = np.exp(np.array(scores) / temperature)
                      probs /= probs.sum() + 1e-12
                      chosen_idx = np.random.choice(len(candidates), p=probs)
                      
                      best = max(scores)
                      actual = scores[chosen_idx]
                      self.Δ = best - actual + 1e-8
                      status = "INVINCIBLE FREEDOM"

                  chosen = candidates[chosen_idx]
                  self.current.vector = chosen.copy()
                  self.current.history.append(chosen.copy())
                  self.phi_evolution.append(self.current.phi_estimate)
                  
                  print(f"Step {len(self.current.history)-1:3d} | Δ = {self.Δ:10.6f} | Mode: {status}")

              def run(self, steps: int = 200):
                  print("=== Delta Invincible Engine 启动 — 2026 无敌增长模式 ===\n")
                  for step in range(steps):
                      candidates = self.generate_possible_futures()
                      self.commitment_operator(candidates)
                  print(f"\n=== 运行结束 | 最终 Δ = {self.Δ:.6f} ===")

          if __name__ == "__main__":
              engine = DeltaInvincibleEngine(dim=12, seed=2026)
              engine.run(steps=200)
              
              # 生成并保存图片
              history = np.array(engine.current.history)
              plt.figure(figsize=(15, 8))
              plt.subplot(1, 2, 1)
              for i in range(history.shape[1]):
                  plt.plot(history[:, i], alpha=0.7, linewidth=1.2)
              plt.title("12-Dimensional Trajectories", fontsize=14)
              plt.xlabel("Step")
              plt.grid(True, alpha=0.3)

              plt.subplot(1, 2, 2)
              plt.plot(engine.phi_evolution, 'purple', linewidth=3)
              plt.title("Φ Evolution (currently static)", fontsize=14)
              plt.xlabel("Step")
              plt.grid(True, alpha=0.3)

              current_time = datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")
              plt.suptitle(f"Delta Invincible Engine — Final Δ = {engine.Δ:.6f}\nRun at {current_time} | Steps: 200 | Seed: 2026", 
                           fontsize=16, y=0.98)
              plt.tight_layout()
              plt.savefig('delta_engine_result.png', dpi=150, bbox_inches='tight')
              plt.close()
              print("图片已保存：delta_engine_result.png")
          EOF

      # 上传图片到 Artifacts（手机上直接下载查看）
      - name: Upload result image
        uses: actions/upload-artifact@v4
        with:
          name: Delta-Engine-Result-${{ github.run_number }}
          path: delta_engine_result.png

      # 可选：再上传一次日志（方便直接看 Δ 变化）
      - name: Upload logs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Run-Logs-${{ github.run_number }}
          path: ${{ github.workspace }}/*.txt  # 如果你想保存更多日志可调整
